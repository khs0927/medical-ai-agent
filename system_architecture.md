# 의료 AI 에이전트 시스템 아키텍처

## 시스템 개요

이 문서는 의료 AI 에이전트 시스템의 아키텍처를 설명합니다. 이 시스템은 PostgreSQL 데이터베이스와 하이브리드 LLM(MedLLaMA3+Gemini)을 기반으로 의료 질의응답, 문헌 검색, 건강 데이터 분석을 제공합니다.

## 아키텍처 다이어그램

```
                           +-----------------+
                           |                 |
                           |  의료 AI 에이전트  |
                           |                 |
                           +-----------------+
                                   |
                  +----------------+------------------+
                  |                |                  |
        +-----------------+ +----------------+ +----------------+
        |                 | |                | |                |
        |   FastAPI 앱    | |   LLM 클라이언트 | |   외부 API 연동  |
        |                 | |                | |                |
        +-----------------+ +----------------+ +----------------+
              |                   |   |               |
    +---------+----------+        |   |      +--------+--------+
    |                    |        |   |      |                 |
    |  PostgreSQL 데이터베이스 |        |   |      |  PubMed/Kaggle  |
    |                    |        |   |      |                 |
    +--------------------+        |   |      +-----------------+
              |                   |   |
    +---------+----------+        |   |
    |                    |        |   |
    |    검색 시스템(RAG)   +--------+   |
    |                    |            |
    +--------------------+            |
                                      |
                    +-----------------+-----------------+
                    |                 |                 |
            +---------------+  +---------------+  +---------------+
            |               |  |               |  |               |
            |    MedLLaMA   |  |    Gemini    |  |  임베딩 모델    |
            |               |  |               |  |               |
            +---------------+  +---------------+  +---------------+
```

## 주요 컴포넌트

### 1. 의료 AI 에이전트 (agent.py)

시스템의 핵심 컴포넌트로 다음 기능을 담당합니다:
- LLM 클라이언트 초기화 및 관리
- 의료 질의응답 처리
- 도구 및 외부 API 오케스트레이션
- 검색 시스템 활용 및 컨텍스트 준비

### 2. LLM 클라이언트

여러 LLM을 활용한 하이브리드 접근 방식:
- **MedLLaMA/의료 특화 LLM**: 의학적 질의응답 전문성 제공
- **Gemini**: 일반 질의응답 및 복잡한 추론 담당
- **임베딩 모델**: 텍스트 임베딩 생성 및 의미론적 검색 지원

### 3. 데이터베이스 계층 (db/)

PostgreSQL 기반 데이터 저장 및 관리:
- **postgres_config.py**: 데이터베이스 설정 및 연결 관리
- **postgres_models.py**: 데이터 모델 정의 (의학 문헌, 임상 가이드라인 등)
- **postgres_db.py**: CRUD 작업 및 쿼리 처리

### 4. 검색 시스템 (rag/)

검색 증강 생성(RAG) 패턴 구현:
- **postgres_retriever.py**: 텍스트 검색 및 임베딩 기반 의미론적 검색
- 문서 임베딩 생성 및 저장
- 코사인 유사도를 활용한 관련 문서 검색

### 5. API 통합 (api/)

외부 의료 데이터 소스 연동:
- **pubmed_api.py**: PubMed 의학 문헌 검색
- **kaggle_api.py**: Kaggle 의학 데이터셋 검색

### 6. FastAPI 앱 (fastapi_app/)

웹 인터페이스 및 API 엔드포인트:
- **main.py**: REST API 엔드포인트 정의
- 성능 모니터링 및 상태 확인 기능
- 에이전트 실행 및 관리

## 주요 데이터 흐름

1. **사용자 질의 처리**:
   ```
   사용자 질의 → FastAPI → 의료 에이전트 → LLM 처리 → 응답 생성 → 사용자
   ```

2. **검색 증강 생성 (RAG)**:
   ```
   질의 → 텍스트 임베딩 → 의미론적 검색 → 관련 문서 검색 → LLM 컨텍스트 제공 → 응답 생성
   ```

3. **외부 데이터 통합**:
   ```
   질의 → PubMed/Kaggle API 호출 → 관련 문헌/데이터셋 검색 → 결과 가공 → 에이전트에 전달
   ```

## 성능 최적화

1. **메모리 최적화**:
   - 모델 양자화를 통한 메모리 사용량 감소
   - 임베딩 모델 캐싱으로 반복 로드 방지
   - PostgreSQL 연결 풀링으로 데이터베이스 리소스 효율화

2. **속도 최적화**:
   - 비동기 처리를 통한 병렬 작업 수행
   - 모델 사전 로드를 통한 첫 응답 시간 단축
   - 캐싱 전략을 통한 유사 쿼리 고속 처리

3. **확장성**:
   - 모듈화된 설계로 새로운 LLM 모델 추가 용이
   - 멀티 프로세싱 지원으로 서버 부하 분산
   - API 기반 설계로 다양한 클라이언트 통합 가능

## 실행 방법

시스템 실행을 위한 기본 명령어:

```bash
# 환경 변수 템플릿 생성
python run_server.py --generate-env

# 데이터베이스 초기화
python run_server.py --init-db

# 모델 사전 로드
python run_server.py --preload-models

# 서버 실행 (프로덕션 모드)
python run_server.py --workers 4

# 개발 모드 실행 (자동 리로드)
python run_server.py --reload --log-level debug
```

## 환경 변수 설정

주요 환경 변수 설정은 `.env` 파일이나 `README_ENVIRONMENT.md` 문서를 참조하세요. 